
def bid_side_slope(d, start_idx=None, end_idx=None):
    """What's the marginal percent increase in price as I want to sell more?"""
    midprice = d['midprice/100ms'][start_idx:end_idx]
    total_bid_vol = d['total_bid_vol/100ms'][start_idx:end_idx]
    bid_range = d['bid_range/100ms'][start_idx:end_idx]
    return ((bid_range / midprice) * 10**4) / total_bid_vol
    
def offer_side_slope(d, start_idx=None, end_idx=None):
    """What's the marginal percent increase in price as I want to buy more?"""
    midprice = d['midprice/100ms'][start_idx:end_idx]
    total_offer_vol = d['total_offer_vol/100ms'][start_idx:end_idx]
    offer_range = d['offer_range/100ms'][start_idx:end_idx]
    return ((offer_range / midprice) * 10 ** 4) / total_offer_vol 
          


five_second_features = [ 
    'log offer_vol/mean/50s safe_div bid_vol/mean/50s', # log ratio of volumes 
    '(midprice/mean/5s - midprice/mean/50s) safe_div midprice/std/50s', # z-score of 5s midprice against 50s gaussian
    '(midprice/mean/1s - midprice/mean/5s) safe_div midprice/std/1s', # z-score of 1s midprice against 5s gaussian
    'log midprice/mean/5s % weighted_total_price/mean/5s',  # ratio between the midprice and the volume weighted average of all levels
    'spread/mean/5s', 
    'null_100ms_frame/mean/50s', # what percentage of 100ms frames have had messages arriving?
    'last_bid_digit_near_zero/mean/5s', # how close to 0 or 9 is the last digit?
    '(midprice/mean/5s - midprice/min/50s) safe_div (midprice/max/50s - midprice/min/50s)', # where in the range from min to max are we?  
    'offer/std/5s',  # fast standard deviation of the bids 
    'offer/std/500s', # slow standard deviation of the bids
    'weighted_total_price/slope/5s', # what direction has the volume weighted level average been moving? 
    "bid_range/mean/50s - offer_range/mean/50s", # how much wider is the bidside than the offer side? 
    "abs (bid_vol/slope/5s - bid_vol/slope/500s) safe_div bid_vol/std/500s", # how far is the recent bid_volume rate of change deviating from 500s 
    "abs (offer_vol/slope/5s - offer_vol/slope/500s) safe_div offer_vol/std/500s", # how far off is recent offer volume rate of change from 500s
    "clean log bid_range/mean/5s safe_div spread/mean/50s", # how many spreads wide is the verical bid range? 
    "clean log offer_range/mean/5s safe_div spread/mean/50s", # how many spreads wide is the vertical offer range? 
    't % 86400000' # t is milliseconds since midnight, divide by milliseconds in day to normalize
]


raw_features = [
    'midprice/100ms', 
    'weighted_total_price/100ms',
    'message_count/100ms',
    'time_since_last_message/100ms', 
    'bid_range/100ms', 
    'offer_range/100ms', 
    'spread/100ms', 
    't/100ms % 86400000', 
    't_mod_1000/100ms', 
    'bid_vol/100ms', 
    'offer_vol/100ms', 
]
